name: "Bump version number"
on:
  schedule:
    - cron: '0 0 1 * *'
  push:
    branches: [main]

jobs:
  bump_version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - run: rustup update stable && rustup default stable
      - name: Bump versions locally
        id: bump
        run: |
          rustc scripts/publish.rs
          ./publish bump
          version=$(grep 'version =' Cargo.toml | head -n 1 | sed 's/.*"\(.*\)"/\1/')
          echo "::set-output name=version::$version"

      - name: Commit version changes
        run: |
          git config user.name 'Wasmtime Releases'
          git config user.email 'wasmtime-releases@users.noreply.github.com'
          git commit -a -F-<<EOF
          Bump Wasmtime to $version

          [automatically-tag-and-release-this-commit]
          EOF

      - name: Push to remote
        run: |
          git remote set-url origin https://git:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository }}
          git push origin main:ci/bump-version -f

      - name: Make a PR
        run: |
          body=$(cat <<-EOF
          This is an automated pull request from CI which is intended to
          notify maintainers that it's time to release Wasmtime version
          ${{ steps.bump.outputs.version }}. Version numbers have been bumped
          in this PR automatically and the release process will automatically
          enter the next stages once this PR is merged.

          It's recommended that maintainers double-check that RELEASES.md
          is up-to-date. If not please feel free to push to this PR any
          modifications to the release notes.
          EOF
          )
          body=$(echo "$body" | sed 's/$/\\n/' file | tr -d '\n')
          curl --include --request POST \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            --header "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" \
            --data @- << EOF
          {
            "head": "ci/bump-version",
            "base": "main",
            "title": "Release Wasmtime ${{ steps.bump.outputs.version }}",
            "body": "$body",
            "maintainer_can_modify": true

          }
          EOF
